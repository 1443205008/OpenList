name: Dev Branch Auto Build

on:
  push:
    branches: ["dev"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Linux ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            target: linux-amd64-musl
          - arch: arm64
            target: linux-arm64-musl
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get short SHA
        uses: benjlevesque/short-sha@v3.0
        id: short-sha

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Setup web frontend (dev)
        run: bash build.sh dev web
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build for Linux ${{ matrix.arch }}
        uses: OpenListTeam/cgo-actions@v1.1.2
        with:
          targets: ${{ matrix.target }}
          musl-target-format: $os-$musl-$arch
          out-dir: build
          x-flags: |
            github.com/OpenListTeam/OpenList/v4/internal/conf.BuiltAt=$built_at
            github.com/OpenListTeam/OpenList/v4/internal/conf.GitAuthor=OpenList
            github.com/OpenListTeam/OpenList/v4/internal/conf.GitCommit=$git_commit
            github.com/OpenListTeam/OpenList/v4/internal/conf.Version=dev-${{ steps.short-sha.outputs.sha }}
            github.com/OpenListTeam/OpenList/v4/internal/conf.WebVersion=dev

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openlist-dev-${{ steps.short-sha.outputs.sha }}-linux-${{ matrix.arch }}
          path: build/*
          retention-days: 30
          compression-level: 9

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
      - name: Build Results Summary
        run: |
          echo "## ðŸš€ Dev Branch Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`dev\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Short SHA:** \`${{ needs.build.outputs.short-sha || github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Built Platforms:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Linux AMD64 (x86_64)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Linux ARM64 (aarch64)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download:" >> $GITHUB_STEP_SUMMARY
          echo "Check the **Artifacts** section below to download the built binaries." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ“ These are development builds with the latest frontend assets and may be unstable." >> $GITHUB_STEP_SUMMARY
